<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alef:wght@400;700&display=block" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.10/lib/p5.min.js"></script>
    <style>
        body {
            font-family: Alef, sans-serif;
            margin: 0;
            overflow: clip;
        }

        a:focus-visible {
            outline: transparent;
        }

        button, span {
            font-family: inherit;
            font-size: 1.2em;
            padding-block: 0;
        }

        canvas {
            display: block;
        }

        header {
            box-sizing: border-box;
            padding-inline: 1em;
            position: absolute;
            text-align: center;
            text-wrap: balance;
            width: 100%;
        }

        @media (max-height: 600px) {
            h1, h2 {
                display: inline;
                margin-bottom: 0;
            }

            h1 {
                margin-inline-end: 1em;
            }

            h3 {
                margin-top: 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>טַרֶפֶת אותיות</h1>
        <h2>יעל צברי ואיל יהוה גרוּס</h2>
        <h3><u>הוראות:</u> סדרו את המלבנים מחדש כך שייווצר צירוף שגור בן שתי מילים</h3>
    </header>
    <script>
        'use strict'

        let anagrams = `
אדם דגול,דגל אדום
רך ועדין,עורך דין
רפואת חירום,רוחות רפאים
חוסר משמעת,חסר משמעות
בחדר המנוחה,בחורה נחמדה
אוויר קר,אור ירוק
קבעתי תור,עקרות בית
בין לאומית,בלתי יאומן
אוהדת ביתר,תיבת הדואר
עשר דקות,עדות שקר
לוי יצחק,חצי קילו
קומה חמישית,שיחה מקומית
בלתי עביר,בעלי ברית
רגש אנושי,נושא רגיש
עמוד ראשי,ידוע מראש
ירה בעצמו,רבי עוצמה
חיל השלום,חילול השם
ישו הנוצרי,שינוי צורה
אי ספיקה,אייס קפה
מאב לבן,לב מאבן
חג מולד,דג מלוח
דליפת האמוניה,אליפות המדינה
שיער ארוך,עורך ראשי
אוצר לאומי,מוציא לאור
חדיש ביותר,חדר ישיבות
הולך לפח,לוח הכפל
לעליית הגג,הגעתי לגיל
במענה הקולי,הבנק העולמי
נומי ילדה,דמי ניהול
נוהג במכונית,מכונית גנובה
מנקה חלונות,נחנקה למוות
שכה אהבת,האש כבתה
אתי חפירה,חיה פראית
להתנקם בי,להקת בנים
העתיד הרחוק,ועדת החקירה
בחירות האמצע,אמצעי תחבורה
קרח יבש,חי בשקר
העמוס ביותר,מוות בעריסה
בר יוחאי,חי ובריא
חיוורי פנים,פינוי חירום
לחדר מיון,חדרי מלון
חברי כנופיות,כנופיית רחוב
לכביש המהיר,כלבי השמירה
מת ונקבר,מנות קרב
החזיקו ידיים,זיהום חיידקי
הישאר רגוע,רגעי האושר
רובי הציד,ביד היוצר
מודה לבורא,במלוא הדרו
פצע ירי,עצי פרי
סוס מרוצים,מרוץ סוסים
בצל ירוק,בקר צלוי
עצי אורן,רועי צאן
נע במהירות,בימת הנוער
בתזמון מושלם,תשלום במזומן
נורה בחזה,רחב הזונה
משוך לאחור,מחושך לאור
עונת המסיק,מסע הקניות
חברת בנייה,נתיב בריחה
מאגיה שחורה,שגיאה חמורה
השחורים והלבנות,החלונות השבורים
`

        anagrams = anagrams.trim().split('\n').filter(anagram => anagram.split(',')[0].trim().length == anagram.split(',')[1].trim().length)
        console.log(anagrams.length, new Set(anagrams.map(x => x.split('').toSorted())).size)
        const match = location.search.slice(1).match(/^\d+$/)?.[0]
        let index = (match ?? localStorage['tarefet']) | 0

        let [values, answer] = anagrams[index].split(',')
        values = [...values.trim().replace(/ך/g, 'כ').replace(/ם/g, 'מ').replace(/ן/g, 'נ').replace(/ף/g, 'פ').replace(/ץ/g, 'צ')]
        answer = answer.trim().replace(/ך/g, 'כ').replace(/ם/g, 'מ').replace(/ן/g, 'נ').replace(/ף/g, 'פ').replace(/ץ/g, 'צ')

        const marginFrac = .5
        const minHeightPixels = 100
        const minOverlap = .15
        const animationRate = .05
        const tol = .05

        const boxWidth = 1 / ((values.length+2)+(values.length-1)*marginFrac)

        const boxes = []
        for (let i = 0; i < values.length; i++) {
            boxes.push({value: values[i], z: 0})
            boxes[i].x = boxes[i].lastX = 1 - boxWidth*(1.5+i*(1+marginFrac))
            boxes[i].y = boxes[i].lastY = .5
        }

        let boxHeight, dragIndex, dragOffsetX, dragOffsetY, solved, clue1, clue2, clue3, a

        function getClue1() {
            clue1.remove()
            clue1 = createSpan(`<b>רמז 1:</b> ${answer.split(' ')[0].length} אותיות, ${answer.split(' ')[1].length} אותיות`)
            clue2 = createButton('רמז 2')
            clue2.mouseClicked(getClue2)
        }

        function getClue2() {
            clue2.remove()
            clue2 = createSpan(`<b>רמז 2:</b> מתחיל ב־${answer[0]}, מתחיל ב־${answer.split(' ')[1][0]}`)
            clue3 = createButton('רמז 3')
            clue3.mouseClicked(getClue3)
        }

        function getClue3() {
            clue3.remove()
            clue3 = createSpan(`<b>רמז 3:</b> מסתיים ב־${answer.split(' ')[0].slice(-1)}, מסתיים ב־${answer.slice(-1)}`)
        }

        function getBoxHeight() {
            return max(boxWidth * width / height, minHeightPixels / height)
        }

        function setup() {
            createCanvas(windowWidth, windowHeight).elt.addEventListener('dragstart', e => e.preventDefault())
            cursor('grab')
            frameRate(480)
            boxHeight = getBoxHeight()
            textAlign(CENTER, CENTER)
            textFont('Alef')
            clue1 = createButton('רמז 1')
            clue1.mouseClicked(getClue1)
        }

        function draw() {
            background(255)
            let topZ
            boxes.toSorted((a, b) => a.z - b.z).forEach(box => topZ = drawBox(box).z)
            const candidate = boxes.reduce((s, box) => s += box.value, '')
            if (solved) {
                clue1.hide()
                clue2?.hide()
                clue3?.hide()
                if (!a) {
                    index = (index+1) % anagrams.length
                    localStorage['tarefet'] = index
                    a = createA(`${location.pathname}?${index}`, 'לאתגר הבא')
                    a.elt.focus()
                }
                a.position(0, height * .8)
                a.center('horizontal')
            } else {
                solved = !topZ && candidate == answer
                if (clue1) {
                    clue1.position(0, height * .7)
                    clue1.center('horizontal')
                }
                if (clue2) {
                    clue2.position(0, height * .8)
                    clue2.center('horizontal')
                }
                if (clue3) {
                    clue3.position(0, height * .9)
                    clue3.center('horizontal')
                }
            }
        }

        function drawBox(box) {
            const i = boxes.indexOf(box)
            if (i == dragIndex)
                fill(38, 185, 241, 224)
            else {
                const rate = min(animationRate * 60 / frameRate(), 1)
                box.x += (box.lastX-box.x) * rate
                box.y += (box.lastY-box.y) * rate
                if (abs(box.x - box.lastX) < boxWidth * tol && abs(box.y - box.lastY) < boxHeight * tol)
                    box.z = 0
                fill(solved ? '#64ff64' : 192)
            }
            noStroke()
            rect((box.x-boxWidth/2) * width, box.y*height - boxHeight/2*height, boxWidth * width, boxHeight * height, 3)
            fill(0)
            textSize(boxWidth * width * .8)
            let value = box.value
            if (i != dragIndex && ((i == boxes.length - 1) || boxes[i + 1].value == ' '))
                value = value.replace('כ', 'ך').replace('מ', 'ם').replace('נ', 'ן').replace('פ', 'ף').replace('צ', 'ץ')
            text(value, box.x * width, box.y * height)
            return box
        }

        function getOverlap(box1, box2) {
            let overlapX = max(0, (min(box1.x, box2.x)-max(box1.x, box2.x))/boxWidth + 1)
            let overlapY = max(0, (min(box1.y, box2.y)-max(box1.y, box2.y))/boxHeight + 1)
            return overlapX * overlapY
        }

        function mousePressed() {
            if (solved || mouseButton && mouseButton != 'left')  // https://github.com/processing/p5.js/issues/7397
                return
            const mX = mouseX / width
            const mY = mouseY / height
            for (let i = 0; i < boxes.length; i++)
                if (abs(mX - boxes[i].x) < boxWidth / 2 && abs(mY - boxes[i].y) < boxHeight / 2) {
                    cursor('grabbing')
                    dragIndex = i
                    dragOffsetX = (boxes[i].x-mX) / boxWidth
                    dragOffsetY = (boxes[i].y-mY) / boxHeight
                    boxes[i].z = max(boxes.map(box => box.z)) + 1
                    break
                }
        }

        function mouseDragged() {
            if (dragIndex == null)
                return
            boxes[dragIndex].x = mouseX/width + dragOffsetX*boxWidth
            boxes[dragIndex].y = mouseY/height + dragOffsetY*boxHeight
            let targetIndex
            let bestOverlap = minOverlap
            for (let i = 0; i < boxes.length; i++)
                if (!boxes[i].z) {
                    const overlap = getOverlap(boxes[i], boxes[dragIndex])
                    if (overlap > bestOverlap) {
                        bestOverlap = overlap
                        targetIndex = i
                    }
                }
            if (targetIndex != null) {
                const {value, x, y, z} = boxes[dragIndex]
                boxes[dragIndex].value = boxes[targetIndex].value
                boxes[dragIndex].x = boxes[targetIndex].x
                boxes[dragIndex].y = boxes[targetIndex].y
                boxes[targetIndex].value = value
                boxes[targetIndex].x = x
                boxes[targetIndex].y = y
                boxes[targetIndex].z = z + 1
                dragIndex = targetIndex
            }
        }

        function mouseReleased() {
            cursor('grab')
            dragIndex = null
        }

        addEventListener('blur', mouseReleased)

        // https://github.com/processing/p5.js/issues/7195
        function touchStarted() {
            mousePressed()
        }
        function touchMoved() {
            mouseDragged()
        }
        function touchEnded() {
            if (!touches.length)
                mouseReleased()
        }

        function windowResized() {
            resizeCanvas(document.documentElement.clientWidth, document.documentElement.clientHeight)  // Needed for orientation change on Chrome Android. See: https://github.com/processing/p5.js/issues/8121
            boxHeight = getBoxHeight()
        }
    </script>
</body>
</html>